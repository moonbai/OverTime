# modules/holiday.py
from datetime import datetime

class HolidayChecker:
    """èŠ‚å‡æ—¥æ£€æŸ¥å™¨ - ä½¿ç”¨ chinese_calendar"""

    def __init__(self):
        self.calendar_available = False
        self.holidays = {}

        # æ£€æµ‹ chinese_calendar
        try:
            import chinese_calendar
            self.calendar_available = True
            print("âœ“ chinese_calendar å·²é›†æˆï¼ˆæ”¯æŒ2004-2026å¹´ï¼‰")
        except ImportError:
            print("âš  chinese_calendar æœªå®‰è£…ï¼Œä½¿ç”¨å†…ç½®æ•°æ®")
            self.calendar_available = False

        # å†…ç½®èŠ‚å‡æ—¥æ•°æ®ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
        self.holidays = {
            "2024": {
                "01-01": ("èŠ‚å‡æ—¥", "å…ƒæ—¦"),
                "02-10": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "02-11": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "02-12": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "04-04": ("èŠ‚å‡æ—¥", "æ¸…æ˜èŠ‚"),
                "05-01": ("èŠ‚å‡æ—¥", "åŠ³åŠ¨èŠ‚"),
                "06-10": ("èŠ‚å‡æ—¥", "ç«¯åˆèŠ‚"),
                "09-17": ("èŠ‚å‡æ—¥", "ä¸­ç§‹èŠ‚"),
                "10-01": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-02": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-03": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "01-04": ("è°ƒä¼‘æ—¥", "å…ƒæ—¦è°ƒä¼‘"),
                "02-04": ("è°ƒä¼‘æ—¥", "æ˜¥èŠ‚è°ƒä¼‘"),
                "02-18": ("è°ƒä¼‘æ—¥", "æ˜¥èŠ‚è°ƒä¼‘"),
                "04-07": ("è°ƒä¼‘æ—¥", "æ¸…æ˜è°ƒä¼‘"),
                "05-02": ("è°ƒä¼‘æ—¥", "åŠ³åŠ¨èŠ‚è°ƒä¼‘"),
                "06-11": ("è°ƒä¼‘æ—¥", "ç«¯åˆè°ƒä¼‘"),
                "09-18": ("è°ƒä¼‘æ—¥", "ä¸­ç§‹è°ƒä¼‘"),
                "10-07": ("è°ƒä¼‘æ—¥", "å›½åº†è°ƒä¼‘"),
            },
            "2025": {
                "01-01": ("èŠ‚å‡æ—¥", "å…ƒæ—¦"),
                "01-28": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "01-29": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "01-30": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "01-31": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "02-01": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "02-02": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "04-04": ("èŠ‚å‡æ—¥", "æ¸…æ˜èŠ‚"),
                "05-01": ("èŠ‚å‡æ—¥", "åŠ³åŠ¨èŠ‚"),
                "05-02": ("èŠ‚å‡æ—¥", "åŠ³åŠ¨èŠ‚"),
                "05-03": ("èŠ‚å‡æ—¥", "åŠ³åŠ¨èŠ‚"),
                "06-01": ("èŠ‚å‡æ—¥", "å„¿ç«¥èŠ‚"),
                "06-19": ("èŠ‚å‡æ—¥", "ç«¯åˆèŠ‚"),
                "10-01": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-02": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-03": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-04": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-05": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-06": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-07": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-08": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-29": ("èŠ‚å‡æ—¥", "é‡é˜³èŠ‚"),
                "01-26": ("è°ƒä¼‘æ—¥", "æ˜¥èŠ‚è°ƒä¼‘"),
                "02-08": ("è°ƒä¼‘æ—¥", "æ˜¥èŠ‚è°ƒä¼‘"),
                "04-07": ("è°ƒä¼‘æ—¥", "æ¸…æ˜è°ƒä¼‘"),
                "05-06": ("è°ƒä¼‘æ—¥", "åŠ³åŠ¨èŠ‚è°ƒä¼‘"),
                "06-02": ("è°ƒä¼‘æ—¥", "å„¿ç«¥èŠ‚è°ƒä¼‘"),
                "06-20": ("è°ƒä¼‘æ—¥", "ç«¯åˆè°ƒä¼‘"),
                "10-09": ("è°ƒä¼‘æ—¥", "å›½åº†è°ƒä¼‘"),
                "10-10": ("è°ƒä¼‘æ—¥", "å›½åº†è°ƒä¼‘"),
            },
            "2026": {
                "01-01": ("èŠ‚å‡æ—¥", "å…ƒæ—¦"),
                "02-17": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "02-18": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "02-19": ("èŠ‚å‡æ—¥", "æ˜¥èŠ‚"),
                "04-05": ("èŠ‚å‡æ—¥", "æ¸…æ˜èŠ‚"),
                "05-01": ("èŠ‚å‡æ—¥", "åŠ³åŠ¨èŠ‚"),
                "06-19": ("èŠ‚å‡æ—¥", "ç«¯åˆèŠ‚"),
                "10-01": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-02": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "10-03": ("èŠ‚å‡æ—¥", "å›½åº†èŠ‚"),
                "01-04": ("è°ƒä¼‘æ—¥", "å…ƒæ—¦è°ƒä¼‘"),
                "02-15": ("è°ƒä¼‘æ—¥", "æ˜¥èŠ‚è°ƒä¼‘"),
                "02-22": ("è°ƒä¼‘æ—¥", "æ˜¥èŠ‚è°ƒä¼‘"),
                "05-02": ("è°ƒä¼‘æ—¥", "åŠ³åŠ¨èŠ‚è°ƒä¼‘"),
                "10-08": ("è°ƒä¼‘æ—¥", "å›½åº†è°ƒä¼‘"),
                "10-09": ("è°ƒä¼‘æ—¥", "å›½åº†è°ƒä¼‘"),
            }
        }

    # modules/holiday.py - get_day_type æ–¹æ³•

    def get_day_type(self, date_str: str) -> tuple:
        """è·å–æ—¥æœŸç±»å‹ï¼š(ç±»å‹, åŸå› )"""
        try:
            # 1. ä¼˜å…ˆä½¿ç”¨ chinese_calendar
            if self.calendar_available:
                try:
                    import chinese_calendar as calendar
                    date_obj = datetime.strptime(date_str, "%Y-%m-%d").date()

                    # è·å–è¯¦ç»†ä¿¡æ¯
                    is_holiday, holiday_name = calendar.get_holiday_detail(date_obj)
                    is_in_lieu = calendar.is_in_lieu(date_obj)
                    is_workday = calendar.is_workday(date_obj)

                    # å¤„ç† holiday_name
                    if holiday_name:
                        name = holiday_name.value if hasattr(holiday_name, 'value') else str(holiday_name)
                    else:
                        name = "èŠ‚å‡æ—¥"

                    # ğŸ†•ä¿®æ­£çš„åˆ¤æ–­é€»è¾‘
                    is_weekend = self._is_weekend(date_str)

                    # æƒ…å†µ1: å‘¨æœ« + æ˜¯å·¥ä½œæ—¥ = è°ƒä¼‘æ—¥
                    if is_weekend and is_workday:
                        return ("è°ƒä¼‘æ—¥", name)

                    # æƒ…å†µ2: å‘¨æœ« + ä¸æ˜¯å·¥ä½œæ—¥ = ä¼‘æ¯æ—¥
                    if is_weekend and not is_workday:
                        return ("ä¼‘æ¯æ—¥", "å‘¨æœ«")

                    # æƒ…å†µ3: æ³•å®šèŠ‚å‡æ—¥
                    if is_holiday:
                        return ("èŠ‚å‡æ—¥", name)

                    # æƒ…å†µ4: å·¥ä½œæ—¥
                    if is_workday:
                        return ("å·¥ä½œæ—¥", "å·¥ä½œæ—¥")

                    # æƒ…å†µ5: å…¶ä»–æƒ…å†µ
                    return ("ä¼‘æ¯æ—¥", "ä¼‘æ¯æ—¥")

                except Exception as e:
                    print(f"chinese_calendarè°ƒç”¨å¤±è´¥: {e}")

            # 2. ä½¿ç”¨å†…ç½®æ•°æ®å¤‡ç”¨
            year = date_str.split('-')[0]
            month_day = date_str[5:]

            if year in self.holidays and month_day in self.holidays[year]:
                return self.holidays[year][month_day]

            # 3. åŸºç¡€åˆ¤æ–­
            date_obj = datetime.strptime(date_str, "%Y-%m-%d")
            weekday = date_obj.weekday()

            if weekday < 5:
                return ("å·¥ä½œæ—¥", "å·¥ä½œæ—¥")
            else:
                return ("ä¼‘æ¯æ—¥", "å‘¨æœ«")

        except Exception as e:
            print(f"âš åˆ¤æ–­æ—¥æœŸç±»å‹å¤±è´¥: {e}")
            return ("æœªçŸ¥", "åˆ¤æ–­å¤±è´¥")

    def _is_weekend(self, date_str: str) -> bool:
        """åˆ¤æ–­æ˜¯å¦æ˜¯å‘¨æœ«"""
        try:
            date_obj = datetime.strptime(date_str, "%Y-%m-%d")
            return date_obj.weekday() >= 5  # 5=å‘¨å…­, 6=å‘¨æ—¥
        except:
            return False

    def get_supported_years(self) -> list:
        """è·å–æ”¯æŒçš„å¹´ä»½"""
        if self.calendar_available:
            return ["2004", "2005", "2006", "2007", "2008", "2009", "2010",
                    "2011", "2012", "2013", "2014", "2015", "2016", "2017",
                    "2018", "2019", "2020", "2021", "2022", "2023", "2024",
                    "2025", "2026"]
        else:
            return ["2024", "2025", "2026"]
